<!DOCTYPE html>
<html>
	<head>
		<title>weather</title>
		<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
		<meta charset="utf-8">
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCyxCKbcngJdOCjgP1-UnRIhEBIc-tIVtM&libraries=places&signed_in=true&callback=initMap"
         async defer></script>	        
	    </script>

		<style type="text/css">
			html, body {
				margin: 0;
				padding: 0;
				height: 100%;
				width: 100%;
			}
			#map {
				top: 6%;
				height: 94%;
			}

		</style>
	</head>

	<body>
		<style type="text/css">
			header{
				background: black;
				height: 100%;
			}
			.float { 
				position: relative;
				float: left;
				bottom: 94%; 
			}
		</style>	

		<header>
		    <div id="map"></div>

            <div class="float" style="margin: 0.2% 0 0 0.1%; font-size: 200%; color: grey;">Weather</div>
            <div class="float" style="margin: 0.7% 0 0 1%; font-size: 150%; color: grey;">best ever</div>


			<input class="float" style="margin: 0 0 0 20%; height: 5%; width: 20%; font-size: 120%;" id="city-input" type="text" placeholder="Enter a location">

            <img id="android_icon" class="float" style="margin: 0.3% 0 0 15%; height: 5%; width: 3.5%;" src="android_icon.png">
            <img class="float" style="margin: 0.3% 0 0 5%; height: 4.5%; width: 4%;" src="ios_icon.ico">
            <img class="float" style="margin: 0.3% 0 0 5%; height: 5%; width: 4%;" src="weixin_icon.png">

            <div class="float"><img id="android_qr" style="clear: left; margin: 2% 0 0 65%; height: 30%; width: 30%;" src=""></div>			

			<p style="background: rgba(255,255,255,0.8); position: absolute; left: 10%; top: 20%;" id="city-name"></p>
			<p style="background: rgba(255,255,255,0.8); position: absolute; left: 10%; top: 30%;" id="city-name2"></p>
			<p style="background: rgba(255,255,255,0.8); position: absolute; left: 10%; top: 40%;" id="city-name3"></p>
			<p style="background: rgba(255,255,255,0.8); position: absolute; left: 10%; top: 50%;" id="city-name4"></p>
			<p style="background: rgba(255,255,255,0.8); position: absolute; left: 10%; top: 60%;" id="city-name5"></p>

		    
		</header>

	    <script src="jquery-2.1.4.js"></script>

	    <script>
	    //google map
			// Note: This example requires that you consent to location sharing when
			// prompted by your browser. If you see the error "The Geolocation service
			// failed.", it means you probably did not give permission for the browser to
			// locate you.
			var cityInput = document.getElementById("city-input");
			var cityName1 = document.getElementById("city-name");
			var cityName2 = document.getElementById("city-name2");
			var cityName3 = document.getElementById("city-name3");
			var cityName5 = document.getElementById("city-name4");
			var cityName4 = document.getElementById("city-name5");
			var city = -1;

			
			var pos = {
				lat: -1,
				lng: -1
	        };

			function initMap() {
			    var map = new google.maps.Map(document.getElementById('map'), {
			        center: {lat: 40.7127, lng: -74.0059},
			    	zoom: 4
			    });

			    var searchBox = new google.maps.places.SearchBox(cityInput);


			    //click, drop a marker with infoWindow--------------------
			    var infoWindow1 = new google.maps.InfoWindow({map: map});
				marker2 = new google.maps.Marker({
					map: map,
					draggable: true,
					animation: google.maps.Animation.DROP,
					label: "2"
				});
				google.maps.event.addListener(map, 'click', function (click) {
					marker2.setPosition(click.latLng);
					var apiUrl4 = "http://api.openweathermap.org/data/2.5/weather?lat=" + click.latLng.lat() + "&lon=" + click.latLng.lng() + "&APPID=23e396f2ce44b26ef2f7b371af53f5a4";
					$.getJSON(apiUrl4, function(data4) {
						cityName4.innerHTML = "click: " + data4.coord.lon + ", " + data4.coord.lat + "<br>" + "api location: " + data4.name + "<br>" + ((data4.main.temp - 273.15).toFixed(2)) + "°C";
						infoWindow1.setContent(data4.name + "<br>" + ((data4.main.temp - 273.15).toFixed(2)) + "°C");
						infoWindow1.open(map, marker2);	
					});	
				});
				google.maps.event.addListener(marker2, 'drag', function() {
					var apiUrl4 = "http://api.openweathermap.org/data/2.5/weather?lat=" + marker2.getPosition().lat() + "&lon=" + marker2.getPosition().lng() + "&APPID=23e396f2ce44b26ef2f7b371af53f5a4";
					$.getJSON(apiUrl4, function(data4) { 
						cityName4.innerHTML = "drag[2]: " + data4.coord.lon + ", " + data4.coord.lat + "<br>" + "api location: " + data4.name + "<br>" + ((data4.main.temp - 273.15).toFixed(2)) + "°C";
						infoWindow1.setContent(data4.name + "<br>" + ((data4.main.temp - 273.15).toFixed(2)) + "°C");
						infoWindow1.open(map, marker2);	
					});
				});				
			    //--------------------------------------------------
				
				//input, enter, display weather, then save--------------------
			    var infoWindow3 = new google.maps.InfoWindow({map: map});
				marker3 = new google.maps.Marker({
					map: map,
					draggable: true,
					animation: google.maps.Animation.DROP,
					label: "3"
				});				
				cityInput.addEventListener("input", cityDisplay);
				function cityDisplay() {
					// console.log(cityInput.value);
					city = cityInput.value;
					if (city.indexOf(",") > 0) {
						var i = city.indexOf(",");
						city = city.substring(0, i);
					}
				    cityName1.innerHTML = 'input: ' + city;
				}
				cityInput.onkeypress = function(e) {
					// console.log(cityInput.value);
				    var event = e || window.event;
				    var charCode = event.which || event.keyCode;

				    if ( charCode == '13' ) {
				      cityDisplay();
				      weatherDispaly();
				    }
				}
				function weatherDispaly() {
				    if (city != -1) {
					    var apiUrl2 = "http://api.openweathermap.org/data/2.5/weather?q=" + city  + "&APPID=23e396f2ce44b26ef2f7b371af53f5a4";
					    $.getJSON(apiUrl2, function(data2) {
					    	var inputLatlng = {
					    		lat: data2.coord.lat,
					    		lng: data2.coord.lon
					    	};
					    	marker3.setPosition(inputLatlng);
						    cityName2.innerHTML = "input: " + city + "<br>" + "api location: " + data2.name + "<br>" + ((data2.main.temp - 273.15).toFixed(2)) + "°C";
							infoWindow3.setContent(data2.name + "<br>" + ((data2.main.temp - 273.15).toFixed(2)) + "°C");
							infoWindow3.open(map, marker3);	
						    map.panTo(inputLatlng);
						    map.setZoom(6);

							var xmlhttp = new XMLHttpRequest();
							xmlhttp.onreadystatechange = function() {
							 if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
							     cityName2.innerHTML = xmlhttp.responseText;
							 }
							}

							xmlhttp.open("GET", "back_mysql_1.php?userid=" + '001' + "&city=" + (data2.name) + "&temp=" + ((data2.main.temp - 273.15).toFixed(0)) + "&time=" + '2015-11-11 11:11:11', true);
							xmlhttp.send();						
						});
					}
				}
				google.maps.event.addListener(marker3, 'drag', function() {
					var apiUrl2 = "http://api.openweathermap.org/data/2.5/weather?lat=" + marker3.getPosition().lat() + "&lon=" + marker3.getPosition().lng() + "&APPID=23e396f2ce44b26ef2f7b371af53f5a4";
					$.getJSON(apiUrl2, function(data2) { 
						cityName2.innerHTML = "drag[3]: " + data2.coord.lon + ", " + data2.coord.lat + "<br>" + "api location: " + data2.name + "<br>" + ((data2.main.temp - 273.15).toFixed(2)) + "°C";
						infoWindow3.setContent(data2.name + "<br>" + ((data2.main.temp - 273.15).toFixed(2)) + "°C");
						infoWindow3.open(map, marker3);	
					});
				});					
				//--------------------------------------------------			


			    // Try HTML5 geolocation.
			    var infoWindow2 = new google.maps.InfoWindow({map: map});
			    if (navigator.geolocation) {
			        navigator.geolocation.getCurrentPosition(function(position) {
			            pos = {
					        lat: position.coords.latitude,
					        lng: position.coords.longitude
			        };
					map.setCenter(pos);
					map.setZoom(8);


					//drop a marker when located--------------------
					marker1 = new google.maps.Marker({
						map: map,
						draggable: true,
						animation: google.maps.Animation.DROP,
						position: pos,
						label: "1"
					});
					google.maps.event.addListener(marker1, 'drag', function() {
						var apiUrl5 = "http://api.openweathermap.org/data/2.5/weather?lat=" + marker1.getPosition().lat() + "&lon=" + marker1.getPosition().lng() + "&APPID=23e396f2ce44b26ef2f7b371af53f5a4";
						$.getJSON(apiUrl5, function(data5) { 
							cityName5.innerHTML = "drag[1]: " + data5.coord.lon + ", " + data5.coord.lat + "<br>" + "api location: " + data5.name + "<br>" + ((data5.main.temp - 273.15).toFixed(2)) + "°C"; 
						infoWindow2.setContent(data5.name + "<br>" + ((data5.main.temp - 273.15).toFixed(2)) + "°C");
						infoWindow2.open(map, marker1);								 
						});
					});
					//--------------------------------------------------

					//display weather when located--------------------
					var apiUrl3 = "http://api.openweathermap.org/data/2.5/weather?lat=" + (pos.lat.toFixed(2)) + "&lon=" + (pos.lng.toFixed(2)) + "&APPID=23e396f2ce44b26ef2f7b371af53f5a4";
					$.getJSON(apiUrl3, function(data3) { 
						cityName3.innerHTML = "location: " + (pos.lat.toFixed(2)) + ", " + (pos.lng.toFixed(2)) + "<br>" + "api location: " + data3.name + "<br>" + ((data3.main.temp - 273.15).toFixed(2)) + "°C";
						infoWindow2.setContent(data3.name + "<br>" + ((data3.main.temp - 273.15).toFixed(2)) + "°C");
						infoWindow2.open(map, marker1);							
					});
					//--------------------------------------------------


			    }, function() {
					handleLocationError(true, infoWindow, map.getCenter());
			    });
				} else {
				    // Browser doesn't support Geolocation
				    handleLocationError(false, infoWindow, map.getCenter());
			    }
			}

			function handleLocationError(browserHasGeolocation, infoWindow, pos) {
				infoWindow.setPosition(pos);
				infoWindow.setContent(browserHasGeolocation ?
	                'Error: The Geolocation service failed.' :
	                'Error: Your browser doesn\'t support geolocation.');
			}
		</script>


	    <script type="text/javascript">
	    //display qr
	    	var androidIcon = document.getElementById("android_icon");
	    	var androidQr = document.getElementById("android_qr");
	    	androidIcon.addEventListener("mouseover", function() {
    			androidQr.src = "android_qr.jpg";
	    	});
	    	androidIcon.addEventListener("mouseleave", function() {
    			androidQr.src = "";
	    	});
	    </script>

	</body>
</html>